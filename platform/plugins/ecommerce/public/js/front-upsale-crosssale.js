(()=>{"use strict";!function(e){if(void 0===window.EcommerceUpSaleCrossSale){var a=function(e){var a=new CustomEvent(e,{detail:arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},cancelable:arguments.length>2&&void 0!==arguments[2]&&arguments[2]});return document.dispatchEvent(a),!a.defaultPrevented},t=function(e){e&&(window.Theme&&"function"==typeof window.Theme.showSuccess?window.Theme.showSuccess(e):window.MartApp&&"function"==typeof window.MartApp.showSuccess?window.MartApp.showSuccess(e):window.ShofyApp&&"function"==typeof window.ShofyApp.showSuccess?window.ShofyApp.showSuccess(e):"function"==typeof window.showSuccess&&window.showSuccess(e))},o=function(e){e&&(window.Theme&&"function"==typeof window.Theme.showError?window.Theme.showError(e):window.MartApp&&"function"==typeof window.MartApp.showError?window.MartApp.showError(e):window.ShofyApp&&"function"==typeof window.ShofyApp.showError?window.ShofyApp.showError(e):"function"==typeof window.showError?window.showError(e):console.error(e))};window.EcommerceUpSaleCrossSale={upsellRefreshUrl:null,crossSaleRefreshUrl:null,init:function(){for(var e=0,a=["MartApp","ShofyApp","ThemeApp","App"];e<a.length;e++){var t=a[e];if(window[t]&&"function"==typeof window[t].initBlockLazyLoading)return}this.initBlockLazyLoading(),this.bindCartEvents(),this.bindCrossSaleEvents()},initBlockLazyLoading:function(){var t=this;e(document).find('[data-bb-toggle="block-lazy-loading"]').each(function(){var o=e(this),d=o.data("url");d&&(d.includes("up-sale-products")||d.includes("cross-sale-products"))&&(d.includes("up-sale-products")&&(t.upsellRefreshUrl=d),d.includes("cross-sale-products")&&(t.crossSaleRefreshUrl=d),e.ajax({url:d,type:"GET",success:function(r){var s=r.data||r;o.replaceWith(s),void 0!==window.LazyLoad&&window.lazyLoadInstance&&window.lazyLoadInstance.update(),d.includes("up-sale-products")&&(a("ecommerce.upsale.bundle.loaded",{html:s,url:d}),e(document).trigger("upsell-bundle-loaded"),t.initUpSaleBundle()),d.includes("cross-sale-products")&&(a("ecommerce.crosssale.loaded",{html:s,url:d}),t.initSlickCarousel())},error:function(e){console.error("Failed to load lazy content:",e)}}))})},initSlickCarousel:function(){var t=e(".ec-cross-sale-carousel.slick-slides-carousel");if(t.length&&void 0!==e.fn.slick&&!t.hasClass("slick-initialized")){var o=t.data("slick")||{};t.slick(o),a("ecommerce.crosssale.carousel.initialized",{element:t[0],config:o})}},bindCartEvents:function(){var e=this;document.addEventListener("ecommerce.cart.added",function(){e.refreshUpSaleSection()}),document.addEventListener("ecommerce.cart.removed",function(){e.refreshUpSaleSection()})},bindCrossSaleEvents:function(){e(document).on("click",'.ec-cross-sale-add-btn[data-bb-toggle="add-to-cart"]',function(d){d.preventDefault(),d.stopPropagation();var r=e(this),s=r.data("url"),c=r.data("id");r.hasClass("loading")||a("ecommerce.crosssale.add-to-cart.before",{element:r[0],productId:c,url:s},!0)&&(r.addClass("loading").prop("disabled",!0),e.ajax({url:s,type:"POST",data:{id:c},success:function(e){e.error?(o(e.message||"Failed to add product to cart"),a("ecommerce.crosssale.add-to-cart.error",{element:r[0],productId:c,error:e.message})):(t(e.message),a("ecommerce.crosssale.add-to-cart.success",{element:r[0],productId:c,data:e.data,message:e.message}),document.dispatchEvent(new CustomEvent("ecommerce.cart.added",{detail:{data:e.data,element:r[0]}})),"function"==typeof window.loadAjaxCart&&e.data&&window.loadAjaxCart(e.data))},error:function(e){o("Failed to add product to cart"),a("ecommerce.crosssale.add-to-cart.error",{element:r[0],productId:c,error:e})},complete:function(){r.removeClass("loading").prop("disabled",!1)}}))})},refreshUpSaleSection:function(){var t=this;if(this.upsellRefreshUrl){var o=e("[data-upsale-bundle]");0!==o.length&&(o.css("opacity","0.5"),e.ajax({url:this.upsellRefreshUrl,type:"GET",success:function(d){var r=d.data||d;o.replaceWith(r),a("ecommerce.upsale.section.refreshed",{html:r}),e(document).trigger("upsell-bundle-loaded"),t.initUpSaleBundle()},error:function(){o.css("opacity","1")}}))}},initUpSaleBundle:function(){var d=this,r=e("[data-upsale-bundle]");if(0!==r.length){var s=r.find("[data-upsale-checkbox]"),c=r.find("[data-upsale-total-price]"),n=r.find("[data-upsale-add-all]"),i=function(e){var a,t=r.data("currency-config")||window.currencies||{},o=t.symbol||"$",d=!1!==t.is_prefix,s=null!==(a=t.decimals)&&void 0!==a?a:2,c=t.thousands_separator||",",n=t.decimal_separator||".",i=parseFloat(e).toFixed(s).replace(".",n).replace(/\B(?=(\d{3})+(?!\d))/g,c);return d?o+i:i+o},l=function(){var t=0,o=0,d=[];s.filter(":checked").each(function(){var a=e(this);t+=parseFloat(a.attr("data-price"))||0,o++,d.push({id:a.attr("data-id"),price:parseFloat(a.attr("data-price"))||0})}),c.text(i(t)),n.prop("disabled",0===o),a("ecommerce.upsale.total.updated",{total:t,formattedTotal:i(t),selectedCount:o,selectedProducts:d})};s.off("change.upsale").on("change.upsale",l),r.find("[data-upsale-add-btn]").off("click.upsale").on("click.upsale",function(d){d.preventDefault();var r=e(this),s=r.closest("[data-upsale-bundle-item]").find("[data-upsale-checkbox]"),c=n.data("parent-product")||r.data("parent-product"),i=r.attr("data-id"),u=r.data("url");a("ecommerce.upsale.add-to-cart.before",{element:r[0],productId:i,parentProduct:c,url:u},!0)&&(r.addClass("loading").prop("disabled",!0),e.ajax({url:u,type:"POST",data:{id:i,reference_product_for_upsale:c},success:function(e){if(r.removeClass("loading"),e.error)return r.prop("disabled",!1),o(e.message||"Failed to add product to cart"),void a("ecommerce.upsale.add-to-cart.error",{element:r[0],productId:i,error:e.message});t(e.message),s.prop("checked",!1).prop("disabled",!0),l(),a("ecommerce.upsale.add-to-cart.success",{element:r[0],productId:i,parentProduct:c,data:e.data||{},message:e.message||""}),document.dispatchEvent(new CustomEvent("ecommerce.cart.added",{detail:{data:e.data||{},element:r[0],message:e.message||""}})),"function"==typeof window.loadAjaxCart&&e.data&&window.loadAjaxCart(e.data)},error:function(e){r.removeClass("loading").prop("disabled",!1),o("Failed to add product to cart"),a("ecommerce.upsale.add-to-cart.error",{element:r[0],productId:i,error:e})}}))}),n.off("click.upsale").on("click.upsale",function(r){r.preventDefault();var c=e(this),n=[],i=c.data("parent-product");if((s.filter(":checked").each(function(){n.push(e(this).attr("data-id"))}),0!==n.length)&&a("ecommerce.upsale.add-all.before",{element:c[0],productIds:n,parentProduct:i},!0)){c.addClass("loading").prop("disabled",!0);var l=0,u=null,p=0,f=function(){if(l>=n.length)return c.removeClass("loading"),a("ecommerce.upsale.add-all.success",{element:c[0],productIds:n,successCount:p,lastResponse:u}),d.refreshUpSaleSection(),u&&!u.error&&u.data&&(document.dispatchEvent(new CustomEvent("ecommerce.cart.added",{detail:{data:u.data,element:c[0],message:u.message||""}})),"function"==typeof window.loadAjaxCart&&window.loadAjaxCart(u.data)),void(p>0&&t("Added ".concat(p," item(s) to cart")));e.ajax({url:c.data("url"),type:"POST",data:{id:n[l],reference_product_for_upsale:i},success:function(e){e.error?o(e.message||"Failed to add product to cart"):p++,u=e},complete:function(){l++,f()}})};f()}}),r.find(".ec-upsell-attributes .product-filter-item").off("change.upsale").on("change.upsale",function(){if(!e(this).prop("disabled")){var t=e(this),o=t.closest(".ec-upsell-attributes"),d=o.closest("[data-upsale-bundle-item]"),r=o.data("target");if(r){var s={attributes:{}};o.find(".product-filter-item:checked").each(function(){var a=e(this).closest(".ec-upsell-attribute-group").data("slug");a&&(s.attributes[a]=e(this).val())}),e.ajax({url:r,type:"GET",data:s,success:function(r){if(r.data){var c=r.data.id,n=r.data.sale_price||r.data.price,i=r.data.error_message,u=r.data.unavailable_attribute_ids||[];if(o.find(".ec-upsell-attribute-option").each(function(){var a=e(this),t=parseInt(a.data("id")),o=a.find('input[type="radio"]');u.includes(t)?(a.addClass("disabled").attr("title",a.data("unavailable-text")||"Not available"),o.prop("disabled",!0)):(a.removeClass("disabled").removeAttr("title"),o.prop("disabled",!1))}),c&&!i){if(d.find(".ec-upsell-variation-id").val(c),d.find("[data-upsale-checkbox]").attr("data-id",c),d.find("[data-upsale-add-btn]").attr("data-id",c).prop("disabled",!1),n){var p=d.find("[data-upsale-checkbox]"),f=parseFloat(p.attr("data-bundle-discount"))||0,m=p.attr("data-bundle-discount-type");f>0&&("percent"===m?n-=n*f/100:n=Math.max(0,n-f)),p.attr("data-price",n),l()}a("ecommerce.upsale.variation.changed",{element:t[0],item:d[0],variationId:c,price:n,attributes:s.attributes,response:r.data})}else i&&(d.find("[data-upsale-add-btn]").prop("disabled",!0),a("ecommerce.upsale.variation.changed",{element:t[0],item:d[0],variationId:null,error:i,attributes:s.attributes,response:r.data}))}}})}}}),l(),a("ecommerce.upsale.bundle.initialized",{section:r[0],checkboxCount:s.length})}}},e(function(){window.EcommerceUpSaleCrossSale.init()})}}(jQuery)})();